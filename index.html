<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn French with Flashcards</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #74ebd5, #acb6e5);
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            background: #ffffff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        .card-container {
            perspective: 1000px;
            margin: 20px auto;
            width: 300px;
            height: 200px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .card-front {
            background-color: #3498db;
            color: white;
        }

        .card-back {
            background-color: #2ecc71;
            color: white;
            transform: rotateY(180deg);
        }

        h1 {
            font-family: 'Roboto Slab', serif;
            color: #34495e;
            margin-bottom: 20px;
            font-size: 3em;
            font-weight: 700;
        }

        h2 {
            font-family: 'Roboto Slab', serif;
            color: #e67e22;
            margin-top: 20px;
            font-size: 1.8em;
            font-weight: 700;
        }

        button {
            font-family: 'Roboto', sans-serif;
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        #difficulty-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        #difficulty-buttons button {
            background-color: #2ecc71;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #difficulty-buttons button:hover {
            background-color: #27ae60;
            transform: scale(1.05);
        }

        #difficulty-buttons button.selected {
            background-color: #1abc9c;
            color: white;
            transform: scale(1.1);
        }

        #random-word {
            font-size: 2.5em;
            font-weight: bold;
            color: #34495e;
            margin: 20px 0;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        #random-word:hover {
            transform: scale(1.1);
        }

        .hidden {
            display: none;
        }

        #loading-screen {
            display: none;
            text-align: center;
            font-size: 1.5em;
            color: #34495e;
        }

        #loading-spinner {
            margin: 20px auto;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #type-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #type-buttons button {
            background-color: #f39c12;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #type-buttons button:hover {
            background-color: #e67e22;
            transform: scale(1.05);
        }

        #type-buttons button.selected {
            background-color: #d35400;
            color: white;
            transform: scale(1.1);
        }

        #digit-buttons button {
            background-color: #3498db;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #digit-buttons button:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        #digit-buttons button.selected {
            background-color: #1abc9c;
            color: white;
            transform: scale(1.1);
        }

        #back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: transparent;
            border: none;
            color: #3498db;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            text-decoration: underline;
        }

        #back-button:hover {
            color: #2980b9;
        }

        #theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            border: none;
            color: #3498db;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            text-decoration: underline;
        }

        #theme-toggle:hover {
            color: #2980b9;
        }

        body.dark {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
        }

        body.dark .game-container {
            background: #2c3e50;
            color: #ecf0f1;
        }

        body.dark button {
            background-color: #34495e;
            color: #ecf0f1;
        }

        body.dark button:hover {
            background-color: #2c3e50;
        }

        body.dark #type-buttons button.selected {
            background-color: #e67e22;
        }

        body.dark #difficulty-buttons button.selected {
            background-color: #27ae60;
        }

        body.dark #back-button,
        body.dark #theme-toggle {
            color: #ecf0f1;
        }

        body.dark #back-button:hover,
        body.dark #theme-toggle:hover {
            color: #bdc3c7;
        }

        body.dark h1 {
            color: #f1c40f; /* Bright yellow for the main title in dark mode */
        }
    </style>
</head>
<body>
    <button id="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
    <div id="page-1" class="game-container">
        <h1>Learn French with Flashcards</h1>
        <h2>Select Type:</h2>
        <div id="type-buttons">
            <button onclick="selectAlphabet()">Alphabet</button>
            <button onclick="selectType('word')">Word</button>
            <button onclick="selectType('sentence')">Sentence</button>
            <button onclick="selectNumber()">Number</button> <!-- Added Number option -->
        </div>
        <h2>Select Difficulty:</h2>
        <div id="difficulty-buttons">
            <button onclick="selectLevel('a1')">A1</button>
            <button onclick="selectLevel('a2')">A2</button>
            <button onclick="selectLevel('b1')">B1</button>
            <button onclick="selectLevel('b2')">B2</button>
            <button onclick="selectLevel('c1')">C1</button>
            <button onclick="selectLevel('c2')">C2</button>
        </div>
        <button id="start-button" class="hidden" onclick="startGame()">Start</button>
    </div>

    <div id="digit-selection-page" class="game-container hidden">
        <h2>Select Number of Digits:</h2>
        <div id="digit-buttons">
            <button onclick="selectDigits(1)">1 Digit</button>
            <button onclick="selectDigits(2)">2 Digits</button>
            <button onclick="selectDigits(3)">3 Digits</button>
            <button onclick="selectDigits(4)">4 Digits</button>
            <button onclick="selectDigits(5)">5 Digits</button>
        </div>
        <button id="start-button" class="hidden" onclick="startGame()">Start</button>
    </div>

    <div id="loading-screen" class="game-container">
        <h2>Loading...</h2>
        <div id="loading-spinner"></div>
    </div>

    <div id="page-2" class="game-container hidden">
        <button id="back-button" onclick="goBack()">Back</button>
        <div class="card-container" onclick="toggleCard()">
            <div id="flashcard" class="card">
                <div class="card-face card-front" id="card-front"></div>
                <div class="card-face card-back" id="card-back"></div>
            </div>
        </div>
        <div>
            <button onclick="recordFailure()">I failed :(</button>
            <button onclick="recordSuccess()">I got it :)</button>
        </div>
    </div>

    <script>
        const apiUrl = 'https://sheetdb.io/api/v1/fywkxb03nt5ev';
        const ttsApiKey = 'AIzaSyB8NJx5IYC-0xDHXH5Vz9B3DPDR25kkggk';
        let selectedDifficulty = '';
        let selectedType = 'word'; // Default to "Word"
        let selectedDigits = 0; // Number of digits for random numbers
        let allCards = [];
        let currentWord = '';
        let currentTranslation = '';
        let nextWordData = null; // Preloaded next word and translation
        let successCount = 0;
        let failureCount = 0;

        // Spaced repetition system
        const cardQueue = []; // Queue of cards to show
        const failedCards = []; // Cards that need to be repeated more often

        // Expanded voice pool with different nationalities and accents
        const voices = [
            { languageCode: 'fr-FR', name: 'fr-FR-Wavenet-A' }, // French (France)
            { languageCode: 'fr-FR', name: 'fr-FR-Wavenet-B' }, // French (France)
            { languageCode: 'fr-FR', name: 'fr-FR-Wavenet-C' }, // French (France)
            { languageCode: 'fr-FR', name: 'fr-FR-Wavenet-D' }, // French (France)
            { languageCode: 'fr-CA', name: 'fr-CA-Wavenet-A' }, // French (Canada)
            { languageCode: 'fr-CA', name: 'fr-CA-Wavenet-B' }, // French (Canada)
            { languageCode: 'fr-CA', name: 'fr-CA-Wavenet-C' }, // French (Canada)
            { languageCode: 'fr-CA', name: 'fr-CA-Wavenet-D' }, // French (Canada)
            { languageCode: 'fr-FR', name: 'fr-FR-Standard-A' }, // African French (Standard)
            { languageCode: 'fr-FR', name: 'fr-FR-Standard-B' }, // African French (Standard)
        ];

        function selectType(type) {
            selectedType = type;
            document.querySelectorAll('#type-buttons button').forEach(button => button.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function selectAlphabet() {
            selectedType = 'alphabet';
            document.querySelectorAll('#type-buttons button').forEach(button => button.classList.remove('selected'));
            event.target.classList.add('selected');
            startGame(); // Start the game immediately
        }

        function selectNumber() {
            selectedType = 'number';
            document.querySelectorAll('#type-buttons button').forEach(button => button.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('page-1').classList.add('hidden');
            document.getElementById('digit-selection-page').classList.remove('hidden'); // Show digit selection page
        }

        function selectLevel(level) {
            selectedDifficulty = level;
            document.querySelectorAll('#difficulty-buttons button').forEach(button => button.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('start-button').classList.remove('hidden');
        }

        function selectDigits(digits) {
            selectedDigits = digits;
            document.querySelectorAll('#digit-buttons button').forEach(button => button.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('digit-selection-page').classList.add('hidden'); // Hide digit selection page
            document.getElementById('page-2').classList.remove('hidden'); // Show number card page
            initializeCardQueue(); // Initialize the card queue for numbers
            preloadNextWord(); // Preload the first number
            nextWord(); // Load the first number immediately
        }

        async function startGame() {
            if (selectedType === 'number') {
                generateRandomNumbers(); // Generate random numbers for the cards
                initializeCardQueue(); // Initialize the card queue for numbers
                preloadNextWord(); // Preload the first number
                document.getElementById('page-1').classList.add('hidden');
                document.getElementById('page-2').classList.remove('hidden'); // Show game screen
                nextWord(); // Load the first number immediately
                return; // Skip fetching data for numbers
            }
            document.getElementById('page-1').classList.add('hidden');
            document.getElementById('loading-screen').style.display = 'block'; // Show loading screen
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                allCards = filterWordsByDifficulty(data);
                if (allCards.length > 0) {
                    initializeCardQueue(); // Initialize the card queue
                    preloadNextWord(); // Preload the first word
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none'; // Hide loading screen
                        document.getElementById('page-2').classList.remove('hidden'); // Show game screen
                        nextWord(); // Load the first word immediately
                    }, 1000); // Simulate a short delay for loading
                } else {
                    throw new Error('No words available for the selected difficulty.');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('loading-screen').style.display = 'none'; // Hide loading screen on error
                alert("Failed to load words. Please try again.");
            }
        }

        function initializeCardQueue() {
            cardQueue.length = 0; // Clear the queue
            failedCards.length = 0; // Clear failed cards
            allCards.forEach(card => cardQueue.push({ card, interval: 1 })); // Add all cards with an initial interval of 1
        }

        function generateRandomNumbers() {
            allCards = [];
            for (let i = 0; i < 20; i++) { // Generate 20 random numbers
                const randomNumber = Math.floor(Math.random() * Math.pow(10, selectedDigits));
                allCards.push({ word: randomNumber.toString(), translation: randomNumber.toString() });
            }
        }

        async function preloadNextWord() {
            if (allCards.length > 0) {
                const nextCard = allCards[Math.floor(Math.random() * allCards.length)]; // Randomly select a card
                if (selectedType === 'number') {
                    nextWordData = { word: nextCard.word, translation: nextCard.translation }; // Same number on both sides
                } else if (selectedType === 'sentence') {
                    const sentenceColumn = getSentenceColumn();
                    const sentence = nextCard[sentenceColumn]?.trim();
                    nextWordData = { word: sentence, translation: await translateWord(sentence) };
                } else if (selectedType === 'alphabet') {
                    const alphabet = nextCard['alphabet']?.trim();
                    nextWordData = { word: alphabet, translation: alphabet }; // Back is the same as the front
                } else {
                    const word = nextCard[selectedDifficulty]?.trim();
                    const translation = await translateWord(word);
                    nextWordData = { word, translation };
                }
            } else {
                nextWordData = null;
            }
        }

        async function nextWord() {
            const card = document.getElementById('flashcard');
            const cardFront = document.getElementById('card-front');
            const cardBack = document.getElementById('card-back');

            // Clear the front and back content immediately
            cardFront.textContent = '';
            cardBack.textContent = '';

            card.classList.remove('flipped'); // Reset card to front
            setTimeout(() => {
                if (nextWordData) {
                    // Update the front and back content with preloaded data
                    currentWord = nextWordData.word;
                    currentTranslation = nextWordData.translation;
                    cardFront.textContent = currentWord || "No Word Available";
                    cardBack.textContent = currentTranslation || "Translation unavailable";

                    // Preload the next word or number
                    preloadNextWord();
                } else {
                    cardFront.textContent = "No more words available.";
                    cardBack.textContent = "";
                }
            }, 300); // Reduce delay to 300ms for faster appearance
        }

        function recordFailure() {
            failureCount++;
            console.log(`Failures: ${failureCount}`);
            const failedCard = cardQueue.shift(); // Remove the current card from the queue
            failedCards.push(failedCard); // Add it to the failed cards list
            cardQueue.push(failedCard); // Re-add it to the end of the queue for repetition
            nextWord();
        }

        function recordSuccess() {
            successCount++;
            console.log(`Successes: ${successCount}`);
            const succeededCard = cardQueue.shift(); // Remove the current card from the queue
            succeededCard.interval *= 2; // Double the interval for successful cards
            setTimeout(() => cardQueue.push(succeededCard), succeededCard.interval * 1000); // Re-add it after the interval
            nextWord();
        }

        function goBack() {
            document.getElementById('page-2').classList.add('hidden'); // Hide game page
            document.getElementById('page-1').classList.remove('hidden'); // Show settings page
            console.log(`Final Score - Successes: ${successCount}, Failures: ${failureCount}`);
            successCount = 0; // Reset counters
            failureCount = 0;
        }

        function getSentenceColumn() {
            // Map difficulty to the corresponding sentence column
            if (selectedDifficulty === 'b1') return 'b1sentence';
            if (selectedDifficulty === 'c1') return 'c1sentence';
            if (selectedDifficulty === 'c2') return 'c2sentence'; // Add mapping for C2 difficulty
            return 'a1sentence'; // Default to A1 for easy difficulty
        }

        function filterWordsByDifficulty(data) {
            if (selectedType === 'alphabet') {
                return data.filter(row => row['alphabet']?.trim()); // Filter rows with valid alphabet entries
            }
            const sentenceColumn = getSentenceColumn();
            return data.filter(row => row[selectedDifficulty]?.trim() || row[sentenceColumn]?.trim());
        }

        async function translateWord(word) {
            const url = `https://translation.googleapis.com/language/translate/v2?key=${ttsApiKey}`;
            const body = { q: word, target: 'fr', source: 'en' };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await response.json();
                const parser = new DOMParser();
                return parser.parseFromString(data.data.translations[0].translatedText, 'text/html').body.textContent;
            } catch (error) {
                console.error("Translation Error:", error);
                return "Translation unavailable";
            }
        }

        async function speakText(text) {
            const randomVoice = voices[Math.floor(Math.random() * voices.length)]; // Pick a random voice
            const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${ttsApiKey}`;
            const body = {
                input: { text },
                voice: randomVoice,
                audioConfig: { audioEncoding: 'MP3' },
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await response.json();
                const audio = new Audio(`data:audio/mp3;base64,${data.audioContent}`);
                audio.play();
            } catch (error) {
                console.error("Text-to-Speech Error:", error);
            }
        }

        function toggleCard() {
            const card = document.getElementById('flashcard');
            card.classList.toggle('flipped');
            if (card.classList.contains('flipped') && currentTranslation) {
                speakText(currentTranslation); // Speak the French translation when the card is flipped
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.textContent = document.body.classList.contains('dark') ? 'Light Theme' : 'Dark Theme';
        }

        // Set default theme
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.textContent = 'Dark Theme';
        });
    </script>
</body>
</html>